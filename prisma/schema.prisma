// Prisma schema for OP17 shop platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoleName {
  ADMIN
  MANAGER
  FULFILLMENT
  SUPPORT
}

enum Currency {
  EUR
  USD
  UAH
}

enum CollectionStatus {
  UPCOMING
  LIVE
  ENDED
}

enum SaleMode {
  DROP
  ALWAYS_ON
}

enum BackorderPolicy {
  ALLOW
  DISALLOW
}

enum OrderStatus {
  PENDING
  PAID
  FULFILLED
  SHIPPED
  REFUNDED
}

enum PaymentProvider {
  LIQPAY
  MONOBANK
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  CANCELED
  REFUNDED
}

enum RefundStatus {
  PENDING
  SUCCEEDED
  FAILED
}

enum ShippingCarrier {
  NOVA_POST
}

enum ShippingMethod {
  NOVA_POST_BRANCH
  NOVA_POST_COURIER
}

enum ShipmentStatus {
  PENDING
  PACKED
  SHIPPED
  DELIVERED
  RETURNED
}

enum PromoType {
  PERCENT
  AMOUNT
  FREE_SHIPPING
}

enum OrderEventType {
  ORDER_CREATED
  STATUS_CHANGE
  SHIPMENT_UPDATE
  REFUND_CREATED
  NOTE
}

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  passwordHash String
  name         String?
  phone        String?
  isActive     Boolean    @default(true)
  roles        UserRole[]
  sessions     Session[]
  carts        Cart[]
  orders       Order[]
  orderEvents  OrderEvent[]
  addresses    Address[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Role {
  id        String     @id @default(cuid())
  name      RoleName   @unique
  users     UserRole[]
  createdAt DateTime   @default(now())
}

model UserRole {
  userId String
  roleId String
  user   User @relation(fields: [userId], references: [id])
  role   Role @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
}

model Category {
  id        String     @id @default(cuid())
  name      String
  slug      String     @unique
  parentId  String?
  parent    Category?  @relation("CategoryToParent", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryToParent")
  sortOrder Int        @default(0)
  isActive  Boolean    @default(true)
  products  Product[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Collection {
  id              String           @id @default(cuid())
  name            String
  slug            String           @unique
  description     String?
  status          CollectionStatus @default(UPCOMING)
  saleMode        SaleMode         @default(DROP)
  startsAt        DateTime?
  endsAt          DateTime?
  isVisible       Boolean          @default(true)
  backorderPolicy BackorderPolicy  @default(DISALLOW)
  products        Product[]
  media           Media[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model Product {
  id              String           @id @default(cuid())
  name            String
  slug            String           @unique
  description     String?
  type            String?
  gender          String?
  sport           String?
  categoryId      String?
  category        Category?        @relation(fields: [categoryId], references: [id])
  collectionId    String?
  collection      Collection?      @relation(fields: [collectionId], references: [id])
  basePriceEur    Int
  isActive        Boolean          @default(true)
  isFeatured      Boolean          @default(false)
  backorderPolicy BackorderPolicy  @default(DISALLOW)
  variants        Variant[]
  media           Media[]
  attributes      ProductAttribute[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model Variant {
  id              String           @id @default(cuid())
  productId       String
  product         Product          @relation(fields: [productId], references: [id])
  sku             String           @unique
  name            String?
  size            String?
  color           String?
  priceEur        Int?
  stock           Int              @default(0)
  isActive        Boolean          @default(true)
  backorderPolicy BackorderPolicy  @default(DISALLOW)
  cartItems       CartItem[]
  orderItems      OrderItem[]
  media           Media[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model ProductAttribute {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  key       String
  value     String
  createdAt DateTime @default(now())

  @@index([key, value])
}

model Media {
  id           String      @id @default(cuid())
  productId    String?
  product      Product?    @relation(fields: [productId], references: [id])
  variantId    String?
  variant      Variant?    @relation(fields: [variantId], references: [id])
  collectionId String?
  collection   Collection? @relation(fields: [collectionId], references: [id])
  bucket       String
  objectKey    String
  mimeType     String?
  width        Int?
  height       Int?
  alt          String?
  sortOrder    Int         @default(0)
  createdAt    DateTime    @default(now())
}

model Cart {
  id        String     @id @default(cuid())
  userId    String?
  user      User?      @relation(fields: [userId], references: [id])
  sessionId String?    @unique
  currency  Currency   @default(EUR)
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id           String   @id @default(cuid())
  cartId       String
  cart         Cart     @relation(fields: [cartId], references: [id])
  variantId    String
  variant      Variant  @relation(fields: [variantId], references: [id])
  quantity     Int
  unitPriceEur Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([cartId, variantId])
}

model PromoCode {
  id             String    @id @default(cuid())
  code           String    @unique
  type           PromoType
  value          Int
  isActive       Boolean   @default(true)
  startsAt       DateTime?
  endsAt         DateTime?
  maxRedemptions Int?
  timesRedeemed  Int       @default(0)
  minSubtotalEur Int?
  orders         Order[]
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model Order {
  id                String        @id @default(cuid())
  orderNumber       String        @unique
  userId            String?
  user              User?         @relation(fields: [userId], references: [id])
  email             String
  phone             String?
  status            OrderStatus   @default(PENDING)
  currency          Currency
  fxRate            Decimal?      @db.Decimal(12, 6)
  subtotalEur       Int
  discountEur       Int           @default(0)
  shippingEur       Int           @default(0)
  totalEur          Int
  totalMinor        Int
  promoCodeId       String?
  promoCode         PromoCode?    @relation(fields: [promoCodeId], references: [id])
  shippingAddressId String?
  shippingAddress   Address?      @relation("OrderShippingAddress", fields: [shippingAddressId], references: [id])
  shippingMethod    ShippingMethod
  items             OrderItem[]
  payments          Payment[]
  shipments         Shipment[]
  events            OrderEvent[]
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

model OrderEvent {
  id          String         @id @default(cuid())
  orderId     String
  order       Order          @relation(fields: [orderId], references: [id])
  type        OrderEventType
  message     String
  metadata    Json?
  createdById String?
  createdBy   User?          @relation(fields: [createdById], references: [id])
  createdAt   DateTime       @default(now())

  @@index([orderId])
}

model OrderItem {
  id           String   @id @default(cuid())
  orderId      String
  order        Order    @relation(fields: [orderId], references: [id])
  variantId    String?
  variant      Variant? @relation(fields: [variantId], references: [id])
  productName  String
  variantName  String?
  sku          String?
  unitPriceEur Int
  quantity     Int
  totalEur     Int
  attributes   Json?
  createdAt    DateTime @default(now())
}

model Payment {
  id                String          @id @default(cuid())
  orderId           String
  order             Order           @relation(fields: [orderId], references: [id])
  provider          PaymentProvider
  status            PaymentStatus   @default(PENDING)
  amountMinor       Int
  currency          Currency
  providerPaymentId String?
  providerInvoiceId String?
  raw               Json?
  refunds           Refund[]
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

model Refund {
  id               String       @id @default(cuid())
  paymentId        String
  payment          Payment      @relation(fields: [paymentId], references: [id])
  amountMinor      Int
  status           RefundStatus @default(PENDING)
  reason           String?
  providerRefundId String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

model Shipment {
  id             String          @id @default(cuid())
  orderId        String
  order          Order           @relation(fields: [orderId], references: [id])
  carrier        ShippingCarrier @default(NOVA_POST)
  method         ShippingMethod
  status         ShipmentStatus  @default(PENDING)
  trackingNumber String?
  labelUrl       String?
  metadata       Json?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model Address {
  id                 String   @id @default(cuid())
  userId             String?
  user               User?    @relation(fields: [userId], references: [id])
  name               String
  phone              String?
  country            String
  region             String?
  city               String
  postalCode         String?
  street1            String
  street2            String?
  novaPostOfficeId   String?
  novaPostOfficeName String?
  shippingOrders     Order[]  @relation("OrderShippingAddress")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model FxRate {
  id            String   @id @default(cuid())
  baseCurrency  Currency @default(EUR)
  quoteCurrency Currency
  rate          Decimal  @db.Decimal(18, 8)
  source        String?
  asOf          DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([baseCurrency, quoteCurrency])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  token     String   @unique
  expiresAt DateTime
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}
